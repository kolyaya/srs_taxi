\section{Серверная часть}

	\subsection{Интеграция с Яндекс.Такси}

		DESC: Дальнейшее описание требований агрегатора подразумевают под собой реализованную интеграцию с этим сервисом.  

		\begin{itemize}

		\item{
			TITLE: Интеграция с сервисом Яндекс.Такси\\
			\sr{Агрегатор интегрирован с сервисом Яндекс.Такси согласно протоколу предоставленному компанией Яндекс. Протокол прикреплен к спецификации.}\\
			PRIOR: CRITICAL\\
		}

		\end{itemize}

	\subsection{Интеграция Служб Такси с Агрегатором}

		DESC: Сервис предоставляет API, с помощью которого Службы Такси (партнеров) и Агрегатор обмениваются информацией о заказах, тарифах и водителях. За основу взят програмный интерфейс сервиса Яндекс.Такси.\\

		\subsubsection{Общие требования}

			\begin{itemize}

				\item {

					TITLE: Единая база агрегатора.\\
					\sr{Агрегатор используя информацию полученную от Служб Такси агрегатор-партнеров ведет единую базу водителей.}\\
					PRIOR: CRITICAL\\

				}

			\end{itemize}


		\subsubsection{Профили водителей} \label{aggregator_api_for_ts_drivers_profiles}

			DESC: Агрегатор запрашивает у сервера агрегатор-партнера профили всех имеющихся водителей. Профиль каждого водителя состоит из двух частей: личные данные водителя и характеристики ТС.

			\begin{itemize}

				\item {

					TITLE: Получение данных о профилях водителей.\\
					\sr{Сервер агрегатора запрашивает профили водителей с переодичностью в STAT-\ref{request_freq_driver_profiles}.}\\
					\sr{Описание запрашиваемых данных находиться в разделе \ref{aggregator_api_for_ts_drivers_profiles}.}\\
					PRIOR: CRITICAL\\
				}

			\end{itemize}

			\setlength{\extrarowheight}{2mm}
				\begin{longtable}{|p{4cm}|p{9cm}|}
					\caption {Параметры водителей}\\

				    \hline	\textbf{Параметр}&\textbf{Описание} \\ [2mm]
				    \endfirsthead
				    \hline	\textbf{Параметр}&\textbf{Описание} \\ [2mm]
				    \endhead

					\hline	Идентификатор &  Присваивается Службой Такси. Каждый идентификатор водителя должен быть уникален в рамках Службы Такси. Также идентификаторы должны быть не длиннее 32 символов, и должны состоять только из цифр. \\ [2mm]

				    \hline	Идентификатор тарифа & Для одного водителя может быть указано несколько тарифов. Первым в списке должен идти основной тариф, затем перечисляются тарифы, по которым Водитель готов взять заказ, если более высокий тариф не устраивает клиента. \\ [2mm]

					\hline	Информация о водителе & \begin{itemize} 
														\item ФИО водителя на русском языке.
														\item Номер телефона водителя в формате “+7ХХХХХХХХХХ”.
														\item Год рождения водителя.
														\item Элемент, содержащий характеристики машины.
													\end{itemize} \\ [2mm]

					\hline	Характеристики машины & \begin{itemize} 
														\item Марка и модель автомобиля.
														\item Год выпуска автомобиля.
														\item Цвет машины.
														\item Государственный номер и регион регистрации автомобиля. Причем все буквы номера — заглавные буквы кириллицы.
														\item Номер разрешения на перевозки.
														\item Перевозка животных.
															\begin{itemize} 
																\item «yes» — в машине можно перевозить животных;
																\item «no» — животных перевозить нельзя.
															\end{itemize} 
														\item Квитанция
															\begin{itemize} 
																\item «yes» — водитель может выписать квитанцию об оплате заказа (документ строгой отчетности);
																\item «no» — водитель не может выписать квитанцию.
															\end{itemize}
														\item Детское кресло.
															\begin{itemize} 
																\item <возраст ребенка>
																\item «no» — детского кресла нет.
															\end{itemize}
														\item Автомобильный кондиционер.
															\begin{itemize} 
																\item «yes» — в машине есть кондиционер;
																\item «no» — кондиционера нет.
															\end{itemize}
														\item Разрешено ли курение.
															\begin{itemize} 
																\item «yes» — водитель не курит, пассажирам курить запрещено;
																\item «no» — пассажирам курить разрешено.
															\end{itemize}
														\item Кузов «универсал».
															\begin{itemize} 
																\item «yes» — машина с кузовом «универсал»;
																\item «no» — машина с другим кузовом.
															\end{itemize}
													\end{itemize} \\ [2mm]
					\hline 
				\end{longtable}

		\subsubsection{Обновление статусов водителей}

			\begin{itemize}

				\item{
					TITLE: Запрос на обновление статуса водителя(-ей)\\
					\sr{Сервер агрегатор-партнера отправляет запрос к Агрегатору, сообщая об изменении статуса одного или нескольких водителей агрегатор-партнера.}\\
					\sr{Запрос содержит в себе параметры описанные в таблице \ref{change_driver_status_request_parametrs}.}\\
					PRIOR: MODERATE\\
				}

			\end{itemize}

            \begin{table}[h]
	            \begin{center}
	            \label{change_driver_status_request_parametrs}
	            \caption {Параметры запроса на обновление статуса водителя.}
	            \setlength{\extrarowheight}{2mm}
	            \begin{tabular}{|p{5cm}|p{10cm}|}
	               \hline     \textbf{Параметр}&\textbf{Описание} \\ [2mm]

	               
	               \hline   Идентификатор Службы Такси  & Идентификатор Службы Такси, назначенный сервисом агрегатора.\\ [2mm]

	               \hline   API-ключ  & API-ключ Службы Такси, выданный сервисом агрегатора.\\ [2mm]

	               \hline   Идентификатор водителя  & Идентификатор водителя, назначенный Службой Такси. Параметр может использоваться, если в запросе передается статус только одного водителя. Представляет собой буквенно-цифровую последовательность не длиннее 32 символов. \\ [2mm]
	               
	               \hline   Статус водителя  & 

		               Параметр может использоваться, только если в запросе передается статус одного водителя. 

		               Возможные значения: 
		               		\begin{itemize}
							
								\item {«free» — «свободен», водитель предположительно не занят, но нельзя с определенностью сказать, возьмется ли он за заказ. Агрегатору следует отослать предложение заказа и дождаться подтверждения.}
								
								\item{«busy» — «занят», водитель занят выполнением заказа.}

								\item{«verybusy» — «очень занят», водитель занят и освободится нескоро (взял следующий заказ в очередь, заканчивает работу, планирует перерыв и т. п.).}
							
							\end{itemize} \\ [2mm]

	               \hline
	            \end{tabular}
	            \end{center}
            \end{table}

        \subsubsection{Обновление статусов заказов}

        	DESC: Служба Такси оповещает Агрегатор о каждом изменении статуса заказа. 

        	\begin{itemize}

				\item{
					TITLE: Запрос на обновление статуса заказа\\
					\sr{Сервер агрегатор-партнера отправляет запрос к Агрегатору, сообщая об изменении статуса заказа закрепленного за одним из водителей агрегатор-партнера.}\\
					\sr{Запрос содержит в себе параметры описанные в таблице \ref{change_order_status_request_parametrs}.}\\
					PRIOR: MODERATE\\
				}

			\end{itemize}


			\begin{table}[h]
	            \begin{center}
	            \label{change_order_status_request_parametrs}
	            \caption {Параметры запроса на обновление статуса водителя.}
	            \setlength{\extrarowheight}{2mm}
	            \begin{tabular}{|p{5cm}|p{10cm}|}
	               \hline     \textbf{Параметр}&\textbf{Описание} \\ [2mm]


	               \hline Идентификатор Службы Такси & Идентификатор Службы Такси, назначенный сервисом агрегатора.\\ [2mm]

	               \hline API-ключ & API-ключ Службы Такси, выданный сервисом агрегатора.\\ [2mm]

	               \hline Идентификатор заказа & Идентификатор заказа чей статус которого обновляется.\\ [2mm]

	               \hline Основные статусы & Описаны в разделе - \ref{main_order_status_for_agg}\\ [2mm]

	               \hline Доп. статусы & Описаны в разделе - \ref{extra_order_status_for_agg} \\ [2mm]

	               \hline
	            \end{tabular}
	            \end{center}
            \end{table}

            \paragraph{Основные статусы} \mbox{} \label{main_order_status_for_agg} \\

            	\begin{itemize}

           			\item{

           				TITLE: Передача статусов заказа.\\
           				\sr{Сервер Службы Такси должен передавать статусы только для тех заказов, которые были закреплены за водителями Службы Такси.}\\
           				PRIORITY: CRITICAL\\

           			}

           			\item {

           				TITLE: Возможные статусы.\\
           				\sr{Возможные значения основных статусов перечислены в списке ниже.}
           				PRIORITY: CRITICAL
           			}

           				\begin{itemize}
           					
           					\item{«driving» — “Едет к клиенту”, водитель выехал к клиенту.}

           					\item{«waiting» — “На месте”, водитель прибыл на место назначения, ожидает клиента.}

           					\item{«transporting» — “В пути” водитель везет клиента к месту назначения.}

           					\item{«complete» — “Завершен”, заказ выполнен.} 

           					\item{«cancelled» — “Отменен клиентом”, заказ отменен клиентом.}
           					
           					\item{«failed» — “Отменен водителем”, водитель не смог выполнить заказ.}

           				\end{itemize}
           			

           			\item{

           				TITLE: Порядок изменения статусов.\\
           				\sr{Статус заказа может изменяться только в указанном порядке. То есть, для заказа, находящегося в статусе «transporting», нельзя передать статус «waiting».}\\
           				\sr{Исключениями из правила являются статусы «cancelled» и «failed», которые могут быть переданы в любой момент.}\\
           				PRIORITY: CRITICAL

           			}

           		\end{itemize} 

            \paragraph{Доп. статусы} \mbox{} \label{extra_order_status_for_agg} \\

            	\begin{itemize}

	            	\item {

	           				TITLE: Возможные статусы.\\
	           				\sr{Дополнительная информация, значение которой интерпретируется в зависимости от указанного статуса заказа, передаваемого с помощью параметра “Статус” перечислена в списке ниже.}\\
	           				\sr{В остальных случаях параметр extra игнорируется.}\\
	           				PRIORITY: CRITICAL
	           			}

	           		\begin{itemize}
	           					
	           					\item{«complete» — в параметре следует указать общую цену поездки.}

	           					\item{«failed» и «cancelled» — в параметре следует указать причину невыполнения заказа.}

	           					\item{«driving» — в параметре следует указать идентификатор водителя, выполняющего заказ.}

	           		\end{itemize}

           		\end{itemize}

	\subsection{Обработка заказов}

		\subsubsection{Обработка заказов Яндекс.Такси}

			\begin{table}[h]
	         	\begin{center}
	        	\caption {Действия сервера агрегатора при обработке заказов Яндекс.Такси.}
	         	\label{order_from_yandex_actions_table}
	         	\setlength{\extrarowheight}{2mm}
	         	\begin{tabular}{|p{3cm}|p{3cm}|p{9cm}|}
	            	\hline \textbf{ID} & \textbf{Название}&\textbf{Действие сервера} \\ [2mm]


	             	\hline \srvact{act_robot_check}{} & Проверка на робота &  Проверка n-ого количества водителей на наличие включенных роботов. \\ [2mm]
	             	\hline \srvact{act_messege_about_order_readiness}{} & Сообщение о готовности выполнить заказ & Агрегатор отсылает сервису Яндекс.Такси сообщение о готовности водителя в ответ на запрос с предложением заказа. \\ [2mm]
	             	\hline \srvact{act_order_on_driver_fix}{} & Закреплении заказа & Яндекс.Такси присылает запрос, закрепляющий заказ за водителем.  Агрегатор уведомляет об этом Службу Такси.  \\ [2mm]

	             	\hline
	         	\end{tabular}
	         	\end{center}
     		\end{table}

			\paragraph{Обработка срочных заказов} \mbox{} \\

				TITLE: Алгоритм обработки срочного заказа.\\
				\sr{При предложении срочного заказа агрегатор выполняет ALG-\ref{alg_yandex_express_order}}\\
				PRIOR: MODERATE\\

				\begin{alg}[Алгоритм обработки срочных заказов Яндекс.Такси] \label{alg_yandex_express_order} \mbox{}

					\begin{enumerate}

						\item Предложение о срочном заказе от Яндекса приходит вместе со списком водителей выбранным Яндексом. С полученным списком агрегатор проводит SRVACT-\ref{act_robot_check}.

						\item Если один или несколько водителей из списка проходит(ят) проверку, то от лица каждого из этих водителей агрегатор отправляет SRVACT-\ref{act_messege_about_order_readiness}.
						
						\item Остальным водителям списка агрегатор предлагает заказ, и если один или несколько водителей из списка присылают сообщение о готовности, то агрегатор отправляет SRVACT-\ref{act_messege_about_order_readiness}. 

					\end{enumerate}

				\end{alg}

			\paragraph{Обработка несрочных или предварительных заказов} \mbox{} \\

				TITLE: Алгоритм обработки несрочного заказа.\\
				\sr{При предложении несрочного заказа агрегатор выполняет ALG-\ref{alg_yandex_preliminary_order}}\\
				PRIOR: MODERATE\\

				\begin{alg}[Алгоритм обработки несрочных заказов Яндекс.Такси] \label{alg_yandex_preliminary_order} \mbox{}

					\begin{enumerate}

						\item Если заказ не срочный, то Агрегатор выполняет полный цикл фильтрации описанный в разделе Службы Такси и составляет свой список водителей. 

						\item С имеющимся списком водителей Агрегатор выполняет ALG-\ref{alg_yandex_express_order}.

					\end{enumerate}

				\end{alg}



		\subsubsection{Обработка партнерских заказов}
